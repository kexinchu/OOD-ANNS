# OOD ANNS with dynamic update

## æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ
- å›¾ç´¢å¼•åœ¨ OOD æŸ¥è¯¢æ—¶ï¼Œä¼šé¢ä¸´ç²¾åº¦ä¸‹é™/search å¼€é”€å¢åŠ çš„é—®é¢˜ï¼Œ
- è€Œå¤šæ¨¡æ€ä½¿å¾— OOD-ANNS åœºæ™¯æ›´å¹¿æ³›
- åƒ RoarGraph è¿™ç±»â€œç¦»çº¿ç”¨å¤§é‡å†å²æŸ¥è¯¢åšäºŒåˆ†å›¾æŠ•å½±+è¿é€šæ€§å¢å¼ºâ€çš„æ–¹æ³•æ„å»ºé‡ã€ä¾èµ–è¶³é‡å†å²æŸ¥è¯¢ï¼Œä¸”éš¾ä»¥é€‚é…æŸ¥è¯¢åˆ†å¸ƒæ¼‚ç§»ã€‚

## Related Works
- OOD-DiskANN
- RoarGraph
- NGFix

## Motivation
- ç°æœ‰å·¥ä½œçš„ç¼ºç‚¹
    - å†å²queryé€‰æ‹©ï¼š
        - OOD-DiskANN å’Œ RoarGraphä¸­ æ˜¯offlineé€‰æ‹©ï¼Œevaluationä¸­ä½¿ç”¨çš„å…¨éƒ¨train querys
        - NGFix ç”Ÿæˆèƒ½å¤Ÿæ”¯æŒåœ¨çº¿é€‰æ‹©queryæ¥åœ¨çº¿updateï¼Œä½†æ˜¯queryé€‰æ‹©é€»è¾‘æ˜¯random select (ä»æœ€æ–°queryä¸­)
        - é—®é¢˜ï¼šqueryé€‰æ‹©è¿‡å¤šä¼šå¢åŠ å›¾çš„è¿é€šæ€§ï¼Œå¯¼è‡´query latencyå¢åŠ ï¼›queryé€‰æ‹©è¿‡å°‘ä¼šå› ä¸ºè¿é€šæ€§ä¸è¶³å¯¼è‡´
    - å¹¶ä¸æ˜¯"çœŸæ­£"çš„runtime update â€”â€” åªæ˜¯æ”¯æŒå±€éƒ¨é‡æ„
        - deletion / insertion éƒ½éœ€è¦partial rebuild
        - NGFixéœ€è¦ 28.5% çš„full-rebuild time for insertion + partial-rebuildï¼›6.8% for deletion + update
        - è¿™äº›rebuildçš„æ—¶é—´å†…ï¼š
            - recall æ— æ³•ä¿è¯
            - è¯» + å†™åŒæ—¶å­˜åœ¨ï¼ŒQPS/Latency æ— æ³•ä¿è¯ (ä¸€æ¬¡æ€§æ›´æ–°çš„é‡æ¯”è¾ƒå¤§)

- æˆ‘ä»¬çš„ç›®æ ‡
    - çœŸæ­£çš„ runtime update + OOD
    - ç¡¬ä»¶ç‰¹æ€§?

- Challenges
    - é€‰æ‹© åˆé€‚æ•°é‡ + éœ€è¦çš„query (hard query) æ¥æŒ‡å¯¼ graph update
    - å°† insert + update / delete + update åˆ†æ•£åœ¨æ—¶é—´çº¿ä¸Šï¼›
        - åˆ é™¤nodeçš„ incoming edge æ€ä¹ˆè·å–ï¼Ÿ å¯ä»¥ä¸è€ƒè™‘
        - å½“å‰å•æ¬¡ insert / deletion / NGFix updateçš„å¼€é”€
    - åŠ¨æ€æ›´æ–°
        - ç±»ä¼¼NGFixçš„æ–¹æ³•æ˜¯ å®šæ—¶åˆ é™¤çº¿ä¸Š20% çš„edge + partial rebuildæ¥å¤„ç†
        - å¤§èŒƒå›´åˆ é™¤edgeä¼šå½±å“å›¾çš„è¿é€šæ€§ï¼Œé€ æˆå›¾çš„ä¸å¯ç”¨
    - å¹¶å‘ä¸€è‡´æ€§ (è¯»QPS > å†™QPS)

## Solutions
- 1. **ä½æˆæœ¬**æ£€æµ‹ hard query (easy query è¯´æ˜å½“å‰çš„å›¾ç»“æ„å·²ç»å¾ˆå¥½æ”¯æŒäº†)
    - stage 0: mlæ–¹æ³•ï¼šhardnessæ–¹æ³•([paper](https://arxiv.org/pdf/2505.19001))
        - æ–¹æ³• GBDT (Gradient Boosted Decision Trees)
            - è®ºæ–‡ä¸­çš„æ•ˆæœï¼š100è¯¾æ ‘ï¼Œtree_depth=5/6/7; æ¨ç†æ•ˆæœ 0.03ms
        - Testæ•ˆæœ

        <img src="./pictures/hardness_predictor_scatter.png" width=800>
    
    - stage 1,æ‰°åŠ¨ç¨³å®šæ€§ (Jitter) (å·®å¼‚æ¯”)
        - å¯¹æŸ¥è¯¢å‘é‡åšæå°æ‰°åŠ¨ `q' = normalize(q + ÎµÂ·noise)`, `Îµ âˆˆ [0.01, 0.05]`.
        - å†è·‘ä¸€æ¬¡ç›¸åŒé…ç½®ï¼Œ`J = 1 âˆ’ |R_b(q) âˆ© R_b(q')| / k`
        - é˜ˆå€¼ > P90
    
    <img src="./pictures/query_hardness_scatter_plots.png" width=1000>

- 2. ä½æˆæœ¬çš„è¿‘ä¼¼ EH + Graph update
    - å½“å‰çš„æˆæœ¬
        - å½“å‰çš„ EH è®¡ç®—éœ€è¦è®¡ç®—çŸ©é˜µ(åœ¨subgraphä¸­å¯¹æ¯ä¸ªnode pairéœ€è¦BFS searchä¸€é => O(M^2) )
        - Graph update éœ€è¦æ‰§è¡Œå¤šæ¬¡ï¼ˆk < M^2ï¼‰, ä¸”éœ€è¦æ›´æ–°EHçŸ©é˜µ => O(k * M^2)
    
    - æ€§èƒ½ç“¶é¢ˆåˆ†æ

        - åŸºäº10Mæ•°æ®ï¼Œ1000ä¸ªqueriesçš„æµ‹è¯•ç»“æœ

        | æ¨¡å— | å¹³å‡å»¶è¿Ÿ (ms) | P50 (ms) | P95 (ms) | P99 (ms) | å æ€»æ—¶é—´ | å æ‰€å±ç±»åˆ« | å¤‡æ³¨ |
        | ---- | ----- | ---- | -------- | -------- | ---------- | ---------- | ---------- |
        | **â‘  EH çŸ©é˜µè®¡ç®—ï¼ˆCalculateHardnessï¼‰** | **0.385** | 0.394 | 0.553 | 0.616 | **34.11%** | â€“ | EHæœ¬èº«è¾ƒå¿« |
        | **â‘¡ å…¶ä»–é€»è¾‘ï¼ˆæ€»è®¡ï¼‰** | **0.743** | â€“ | â€“ | â€“ | **65.89%** | 100% | åŒ…å«2.1~2.3 |
        | â–¸ 2.1 f matrix åˆå§‹åŒ–ï¼ˆPrepare Bitsetï¼‰| 0.017 | â€“ | â€“ | â€“ | 1.48% | 2.24% | negligible |
        | â–¸ 2.2 getDefectsFixingEdgesï¼ˆè·ç¦»+æ’åº+é€‰è¾¹ï¼‰| **0.616** | 0.541 | 1.241 | 1.328 | **54.67%** | **82.96%** | **æœ€å¤§ç“¶é¢ˆ** |
        | â–¸ 2.3 Add Edgesï¼ˆé”+add_ngfix_neighborsï¼‰| 0.110 | â€“ | â€“ | â€“ | 9.75%  | 14.80% | éšå›¾çŠ¶æ€æ³¢åŠ¨ |
        | **â‘¢ æ€» NGFix æ—¶é—´** | **1.127** | 1.056 | 1.736 | 2.340 | 100% | â€“ | end-to-end |
    
    - å¦‚ä½•å‡å° EH è®¡ç®—é‡ï¼Ÿ 
        - å›å½’ ANNS queryçš„æœ¬è´¨ï¼šæ£€ç´¢éš¾åº¦ è€Œä¸æ˜¯ å±€éƒ¨çš„escape hardnessï¼›
            - ä»å±€éƒ¨çš„ä¸€ä¸ªnodeè®¿é—®åˆ°å…¶ä»–å…¨éƒ¨top-kann nodeçš„hardness
            - å±€éƒ¨å›¾çš„è¿é€šæ€§ï¼šè¿é€š = å¯è¾¾ => æŒ‰ç…§å¯è¾¾æ€§åˆ’åˆ†æˆå¤šä¸ªgroupï¼Œå¢åŠ edge between groups å³å¯
        - ç›´è§‚çš„ï¼Œå‡å°‘ M å³å¯å‡å° EHçŸ©é˜µçš„ sizeï¼› è€Œå¯¹äºç›¸äº’å¯è¾¾ (hardnes < é˜ˆå€¼Ï„) çš„ kNN pairsï¼Œä¸éœ€è¦å‚ä¸è®¡ç®—
            - ç±»ä¼¼Steiner-Hardnessä¸­ NSG æ–¹æ³•:

            <img src="./pictures/NSG-steiner-hardness.jpeg" width=600>

            - é‡‡å–åˆ†ç»„ç­–ç•¥ï¼š2è·³å†…å¯è¾¾çš„è§†ä¸ºç›¸åŒgroup; demo æµ‹è¯•äº†100ä¸ªquery
            ```shell
            Average M (original node count): 100
            Average m (group count): 39.71
            Average reduction: 60.29%
            Min reduction: 23%
            Max reduction: 85%
            Average original EH latency: 371.54 us
            Average grouped EH latency: 235.72 us
            Speedup: 1.57619x
            Original matrix size (avg): 10000
            Grouped matrix size (avg): 1576.88
            Matrix size reduction: 84.2312%
            ```
        
        - å‡å°‘subgraphä¸­çš„ edge æ•°ç›®ï¼š
            - æ„é€  Ï„-å¯è¾¾å­å›¾ Gt: åœ¨ç¬¬ä¸€éBFSè¿‡ç¨‹ä¸­ï¼Œâ€œåˆ é™¤â€subgraphä¸­çš„ â€œæ˜æ˜¾å›°éš¾çš„â€ è¾¹ï¼›ï¼ˆæŒ‰ç…§ä¸qçš„è·ç¦»æ’åºï¼‰ï¼›
    
    - å¦‚ä½•å‡å° getDefectsFixingEdges çš„è®¡ç®—å¼€é”€
        - distance è®¡ç®— + æ’åºæ“ä½œ

        ```c
        std::vector<std::pair<float, std::pair<int,int> > > vs;
        for(int i = 0; i < Nq; ++i){
            for(int j = 0; j < Nq; ++j){
                if(f[i][j] == 1) {continue;}
                int u = gt[i];
                int v = gt[j]; 
                float d = getDist(u, v);
                vs.push_back({d,{i,j}});
            }
        }
        std::sort(vs.begin(), vs.end());
        ```

        - ä¼˜åŒ–EHä¹‹åï¼Œå¯ä»¥å‡å°‘ node çš„æ•°é‡ï¼Œä¹Ÿå°±å¯ä»¥å‡å°‘distanceè®¡ç®—çš„æ•°é‡
        - æ’åºï¼šå…¶å®æ¯ä¸€è½®åªéœ€è¦å¾—åˆ° distance æœ€å¤§çš„ç»“æœï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸éœ€è¦full sort
        - å¤šè½®å¤„ç†ä¹‹é—´ï¼Œå¯ä»¥å…±äº«è¿™ä¸ªdistanceçŸ©é˜µï¼Œé¿å…é‡å¤è®¡ç®—

    - åˆ é™¤èŠ‚ç‚¹ A çš„ incoming edge å¦‚ä½•è·å–ï¼Ÿ
        - ä¸¤è·³å±€éƒ¨æ‰«æï¼ˆ1-hop/2-hopï¼‰ï¼šå€™é€‰é›†åˆ $ğ¶=Î“(ğ´)âˆªâ‹ƒ_{ğ‘¢âˆˆÎ“(ğ´)}Î“(ğ‘¢)$ï¼ˆA çš„é‚»å±… + é‚»å±…çš„é‚»å±…ï¼‰;å¯¹ ğ¶ ä¸­æ¯ä¸ªèŠ‚ç‚¹æ£€æŸ¥å…¶å‡ºé‚»æ¥è¡¨æ˜¯å¦åŒ…å« Aï¼Œæœ‰åˆ™åˆ ã€‚
            - ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼šè¿‘é‚»å›¾çš„è¾¹å¤§å¤šå±€éƒ¨ï¼ˆè¿‘ä¼¼ RNG/NSG ç»“æ„ï¼‰ï¼ŒæŒ‡å‘ A çš„è¾¹æå¤§æ¦‚ç‡æ¥è‡ª A å‘¨è¾¹çš„ 1â€“2 è·³ã€‚
            - å¤æ‚åº¦ graph å‡ºåº¦ä¸ºMï¼ŒO(M^2), M ä¸€èˆ¬ä¸è¶…è¿‡ 64ï¼› ä¸”ä¸éœ€è¦è·ç¦»è®¡ç®—ï¼Œåªéœ€è¦è¯»å– c çš„neighbor list
        - è¿‘é‚»æ£€ç´¢å€™é€‰ï¼ˆâ€œä»¥ A ä¸ºæŸ¥è¯¢â€çš„å° ef æœç´¢ï¼‰ ï¼šç”¨ A è‡ªèº«å‘é‡åšä¸€æ¬¡ å°æŸå®½æ£€ç´¢ï¼ˆef â‰ª åœ¨çº¿ efï¼‰ï¼Œå–å‰è‹¥å¹²è¿‘é‚»èŠ‚ç‚¹ä¸ºå€™é€‰ï¼Œæ£€æŸ¥å…¶å‡ºé‚»æ¥è¡¨æ˜¯å¦å« A
            - ç¬¦åˆgraphç”Ÿæˆçš„è¿‡ç¨‹é€»è¾‘
        - å¯¹äºå¯èƒ½é—æ¼çš„edgeï¼Œéœ€è¦å®ç°åœ¨çº¿ search è¿‡ç¨‹ä¸­ï¼Œæ”¯æŒè¯†åˆ« + åˆ é™¤

- 3. åŠ¨æ€æ›´æ–° â€”â€” éšç€æ—¶é—´çš„æ¨ç§»ï¼Œä»¥å‰æ–°å¢çš„è¿é€šæ€§mayâ€œè¿‡æœŸâ€äº†
    - å½“å‰workload
    - éšæœºé€‰æ‹©nodeï¼Œåˆ é™¤å†å² added edge
    - ä»¥nodeä¸ºqueryï¼Œå‘èµ·æŸ¥è¯¢ -> æ›´æ–°edge

- 4. å¹¶å‘ä¸€è‡´æ€§
    - runtime delete çš„nodeä¸èƒ½å‡ºç°åœ¨ ANNS è¿”å›ç»“æœä¸­

    - æ–°å¢node/edge è¯»å†™å†²çª


## Evaluation Test
- queryé€‰æ‹©ï¼šå®ç°ç›¸åŒå¹³å‡accä¸‹ï¼Œä½¿ç”¨çš„queryæ•°é‡
    - compare with roargraph and NGFix
- level 0ï¼Œ level 1 çš„ç­›é€‰æ¯”ä¾‹ï¼Œä»¥åŠæœ€ç»ˆå¾—åˆ°çš„set vs ä½¿ç”¨æ ‡å‡†EHçš„åˆ°çš„sets
- ä½æˆæœ¬EHçŸ©é˜µçš„åˆ°çš„è¿é€šæ€§ vs  æ ‡å‡†EHè¿é€šæ€§  +  è®¡ç®—å¼€é”€ compare
- delete nodeä¸­ ä¸¤ç§æ–¹æ³•æ”¶è·çš„incoming edgeæ¯”ä¾‹
- æ•´ä½“æ•ˆæœçš„å¯¹æ¯”ï¼š
    QPS vs recall
    Latency vs recall
    QPS vs è¯»+å†™
    Latency vs è¯»å†™





<!-- ### 1. ç›¸å…³æ–¹å‘å›é¡¾ï¼ˆåŸºäºå…¬å¼€æ–‡çŒ®æ£€ç´¢ï¼‰
#### A. è¿æ¥æ€§å¢å¼ºç±»ï¼šRoarGraph åŠäº²å±

RoarGraph çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šOOD æŸ¥è¯¢ï¼ˆå°¤å…¶æ˜¯è·¨æ¨¡æ€ï¼Œæ¯”å¦‚ç”¨æ–‡æœ¬æ‰¾å›¾åƒï¼‰åœ¨åº•åº“å‘é‡ç©ºé—´é‡Œå¾€å¾€â€œå¾ˆå­¤ç«‹â€ï¼Œè€Œä¸”å®ƒçœŸæ­£çš„è¿‘é‚»å½¼æ­¤ä¹‹é—´ä¹Ÿå¾ˆç–è¿œã€‚è¿™ç ´åäº†ä¼ ç»Ÿ HNSW/NSG å‡è®¾ï¼šå±€éƒ¨é‚»åŸŸæ˜¯å¯†é›†ä¸”è¿é€šçš„ã€‚RoarGraphé€šè¿‡æ„å»ºä¸€ä¸ªâ€œæŠ•å½±äºŒéƒ¨å›¾â€ï¼ˆprojected bipartite graphï¼‰ï¼Œè®©æŸ¥è¯¢æ¨¡æ€å’Œç›®æ ‡æ¨¡æ€ä¹‹é—´å‡ºç°æ›´å¤šé«˜å±‚è·¨ç°‡æ¡¥ï¼Œä»è€Œä¿è¯æŸ¥è¯¢èƒ½æ›´å¿«æŠµè¾¾ç›¸å…³åŒºåŸŸï¼Œè€Œä¸æ˜¯åœ¨å±€éƒ¨ç¨€ç–åŒºåŸŸé‡Œç›²èµ°ã€‚å®éªŒæ˜¾ç¤ºå®ƒèƒ½åœ¨ OOD ä»»åŠ¡ä¸‹æŠŠé«˜å¬å›å»¶è¿Ÿæ˜¾è‘—é™ä¸‹å»ï¼ˆåœ¨ 90% recall ä¸‹æœ€é«˜ 3.56Ã— æé€Ÿï¼‰ã€‚

é—®é¢˜ï¼š
- å®ƒä¸»è¦è§£å†³â€œå¯åˆ°è¾¾æ€§â€ï¼Œä¸æ˜¯â€œç›¸ä¼¼åº¦è´¨é‡â€ã€‚è¾¹è®©ä½ èµ°è¿‡å»äº†ï¼Œä½†æœ€ç»ˆæ‰“åˆ†è¿˜æ˜¯ç”¨åŸç”Ÿè·ç¦»åº¦é‡ã€‚è·¨æ¨¡æ€ embedding çš„å°ºåº¦ä¸ä¸€è‡´ï¼ˆscale mismatchï¼‰å’Œè¯­ä¹‰åç§»æ²¡æœ‰è¢«ä¿®æ­£ï¼Œæ‰€ä»¥æœ€å Top-k ä»å¯èƒ½ä¸æ˜¯è¯­ä¹‰ä¸Šæœ€æ­£ç¡®çš„é‚»å±…ã€‚
- å®ƒéœ€è¦é¢å¤–çš„è·¨æ¨¡æ€æ¡¥è¾¹ï¼ˆæ–°å¢çš„è¾¹ä¼šæ”¾å¤§searchå¼€é”€ï¼‰ï¼Œå°¤å…¶åœ¨é«˜å¬å›åœºæ™¯ä¸‹ï¼Œå€™é€‰é›†å¿…é¡»æ”¾å¤§ï¼Œæœç´¢åŠå¾„ä¹Ÿæ‰©å¤§ï¼Œå¯¼è‡´å»¶è¿Ÿä»ç„¶ä¸Šå‡ã€‚è¿™å¯¹åœ¨çº¿æœåŠ¡å°¤å…¶æ˜¯é«˜å¹¶å‘ä¸‹çš„ tail latency å¾ˆç—›ã€‚
- å¢é‡æ›´æ–°å›°éš¾ï¼šå¤§é‡é¢„å…ˆåŸºäºè®­ç»ƒé›†æŸ¥è¯¢æ·»åŠ çš„è¾¹ï¼Œå¯¹äºæ–°å¢æ•°æ®æœªå¿…é€‚ç”¨ã€‚å¦‚æœæŒç»­æœ‰æ–°åº•åº“å‘é‡æ’å…¥ï¼Œå¦‚ä½•é«˜æ•ˆåœ°ä¸ºå®ƒä»¬å¢æ·»è·¨æ¨¡æ€è¿è¾¹æ˜¯æŒ‘æˆ˜ã€‚

#### B. ç©ºé—´å¯¹é½ / æ˜ å°„ç±»ï¼šè·¨æ¨¡æ€å¯¹é½ã€ç»Ÿä¸€ç©ºé—´ã€å¯¹æ¯”å­¦ä¹ 
å¦ä¸€æ¡çº¿æ˜¯è®©ä¸åŒæ¨¡æ€çš„å‘é‡éƒ½è½åˆ°ï¼ˆæˆ–æ˜ å°„åˆ°ï¼‰åŒä¸€ä¸ªå…±äº«ç©ºé—´ï¼Œé€šè¿‡ CLIP é£æ ¼å¯¹æ¯”å­¦ä¹ ã€çº¿æ€§æŠ•å½±ã€å¤šå¤´æ³¨æ„åŠ›å¼èåˆç­‰ï¼ŒæŠŠ text/image/audio å…¨éƒ¨ embed åˆ°ä¸€ä¸ªå…¬å…±åº¦é‡ç©ºé—´ï¼Œç„¶åç”¨ä¸€ä¸ªç»Ÿä¸€çš„ L2 æˆ–ä½™å¼¦è·ç¦»åšæ£€ç´¢ã€‚å¤§é‡ vision-language è¡¨å¾å­¦ä¹ ã€å¯¹æ¯”å¼å¯¹é½ã€codebookå¼å¯¹é½ã€æ³¨æ„åŠ›å¼è·¨æ¨¡æ€å¯¹é½ã€äº’ä¿¡æ¯æœ€å¤§åŒ–å¼å¯¹é½éƒ½åœ¨å¹²è¿™ä¸ªäº‹[Survey](https://arxiv.org/html/2411.17040v2);[MUST]()ã€‚

é—®é¢˜ï¼š
- çº¿æ€§æŠ•å½±å¾€å¾€æ˜¯å…¨å±€çš„ã€‚ç°å®æ˜¯ï¼šä¸åŒæ¨¡æ€çš„ embedding åˆ†å¸ƒå¹¶ä¸åªæ˜¯çº¿æ€§å¯å¯¹é½ï¼ŒåŒæ—¶ä¸åŒæ¨¡æ€å†…éƒ¨çš„å°ºåº¦ï¼ˆèŒƒæ•°åˆ†å¸ƒã€åæ–¹å·®ç»“æ„ï¼‰å·®å¼‚å¾ˆå¤§ã€‚ç»“æœæ˜¯ï¼ŒæŸä¸ªæ¨¡æ€å¯èƒ½ä¸»å¯¼distanceï¼Œå‡ºç°æ¨¡æ€ä¸»å¯¼æ•ˆåº”ï¼Œå¬å›åç§‘[Mind the Gap](https://arxiv.org/abs/2203.02053)ã€‚
    - ä¸åŒmodalityçš„top10 å¯¼å‡º -> å¯¹æ¯”L2 distance
    - æ–‡æœ¬vector x [vector x] -> image vector ï¼ˆéªŒè¯çš„motivationï¼‰
- ç»Ÿä¸€ç©ºé—´å¾€å¾€æ˜¯â€œå¹³å‡æ„ä¹‰ä¸Šçš„æ­£ç¡®â€ï¼›è¿™ç§æ˜ å°„è½¬åŒ–åœ¨Indexä¸­ï¼Œå¯èƒ½æ‰­æ›²å±€éƒ¨å‡ ä½•ç»“æ„ï¼Œç ´åç»†ç²’åº¦é‚»æ¥å…³ç³»ï¼Œå¯¼è‡´ recall ä¸‹é™ã€‚-> æˆ‘ä»¬ä¸èƒ½åªåšâ€œä¸€åˆ€åˆ‡çš„åŒä¸€ç©ºé—´â€ã€‚
- æ¨¡æ€å°ºåº¦ä¸åŒ¹é…ï¼ˆscale mismatchï¼‰å¯¼è‡´ä¸€æ–¹ä¸»å¯¼ï¼šå¦‚æœä¸åŒæ¨¡æ€åµŒå…¥çš„æ•°å€¼èŒƒå›´æˆ–åˆ†å¸ƒå½¢çŠ¶å·®å¼‚è¾ƒå¤§ï¼Œç›´æ¥ä»¥ç»Ÿä¸€ç©ºé—´è·ç¦»è¿›è¡Œæ£€ç´¢æ—¶ï¼Œå¯èƒ½å‡ºç°ä¸€ç§æ¨¡æ€çš„å‘é‡ä¸»å¯¼è·ç¦»åº¦é‡çš„æƒ…å†µ

### 2, è¦è§£å†³çš„ç—›ç‚¹
- OOD æŸ¥è¯¢åœ¨ç›®æ ‡æ¨¡æ€ä¸­çš„æœ€è¿‘é‚»æ˜¯ç¨€ç–ã€åˆ†æ•£ã€è·¨ç°‡çš„ã€‚è¿™è¦æ±‚ç´¢å¼•å…·æœ‰â€œé•¿è·³èƒ½åŠ›â€å’Œâ€œå¤šå…¥å£èƒ½åŠ›â€ï¼Œä¸ç„¶ä½ èµ°ä¸åˆ°å®ƒä»¬ã€‚ï¼ˆRoarGraph æ–¹å‘åœ¨è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ï¼‰
- è·¨æ¨¡æ€æ£€ç´¢çš„æ‰“åˆ†æœ¬èº«æ˜¯ç•¸å½¢çš„ã€‚ç®€å•çš„ L2 / cosine è·ç¦»åœ¨è·¨æ¨¡æ€åœºæ™¯ä¸‹æ²¡æœ‰æ ¡æ­£èŒƒæ•°ã€åæ–¹å·®ç­‰æ¨¡æ€ä¾èµ–é¡¹ï¼Œå¯¼è‡´æ’åºä¸å‡†ç¡®ï¼›è€Œç›´æ¥æŠŠæ¨¡æ€æŠ•å½±åˆ°ç»Ÿä¸€ç©ºé—´çš„çº¿æ€§å¯¹é½åˆä¼šæŸåçœŸå®æœ€è¿‘é‚»å…³ç³»ã€‚

æˆ‘ä»¬è¦çš„æ˜¯ï¼š
- ä¸€ä¸ªç´¢å¼•ï¼Œå®ƒæœ¬èº«çŸ¥é“â€œè·¨æ¨¡æ€=é«˜é£é™©å°ºåº¦ä¸ä¸€è‡´â€ï¼Œå¹¶åœ¨å€™é€‰æ‰“åˆ†é˜¶æ®µä¸»åŠ¨è¡¥å¿ï¼›
- åŒæ—¶ï¼Œè¿™ä¸ªç´¢å¼•åœ¨å›¾ç»“æ„å±‚é¢ä¹Ÿè¦ä¸º OOD æŸ¥è¯¢æä¾›é«˜æ•ˆå¯è¾¾æ€§ï¼Œä½†ç”¨çš„æ˜¯å—æ§çš„ã€å°‘é‡çš„ç»“æ„æ‰©å±•ï¼Œè€Œä¸æ˜¯ç›²ç›®åŠ å¾ˆå¤šæ¡¥è¾¹ã€‚

### Motivation
æˆ‘ä»¬æŠŠé—®é¢˜æ‹†æˆä¸¤å±‚ï¼Œè€Œä¸æ˜¯åƒç°æœ‰å·¥ä½œä¸€æ ·åœ¨å•å±‚é‡Œå¼ºè¡Œè§£å†³å…¨éƒ¨é—®é¢˜ï¼š

- Routing Layerï¼š
    - ä¸€ä¸ªç¨€ç–ä½†â€œå¤šå…¥å£ awareâ€çš„ä¸Šå±‚å›¾ï¼Œç”¨å°‘é‡è·¨æ¨¡æ€é”šç‚¹èŠ‚ç‚¹ (anchors) è¿æ¥ä¸åŒæ¨¡æ€çš„é«˜å¯†åº¦ç°‡ã€‚å®ƒåªè´Ÿè´£æŠŠæŸ¥è¯¢å¿«é€Ÿå¸¦åˆ°å¤šä¸ªå¯èƒ½ç›¸å…³çš„ç›®æ ‡ç°‡ï¼Œä¸è´Ÿè´£æœ€ç»ˆæ’åºã€‚è¿™ä¸ªå±‚æ¬¡ç»“æ„å€Ÿé‰´ RoarGraph çš„è·¨ç°‡è¿é€šæ€§æ€è·¯ï¼Œä½†æˆ‘ä»¬ä¼šæ§åˆ¶è¾¹é¢„ç®—ï¼Œå¹¶è®©è¿™äº›è·¨æ¨¡æ€é”šç‚¹æ˜¯â€œä»£è¡¨æ€§å­ç©ºé—´çš„å±€éƒ¨ç»Ÿè®¡â€ï¼Œè€Œä¸æ˜¯ä»»æ„èŠ‚ç‚¹ï¼Œä»è€Œå‡å°‘è¾¹æ•°å’Œå†—ä½™éå†ã€‚

- Rerank Layerï¼š
    - ä¸€æ—¦è·¯ç”±å±‚æŠŠæŸ¥è¯¢å¸¦åˆ°è‹¥å¹²å€™é€‰ç°‡ï¼Œæˆ‘ä»¬ä¸ç›´æ¥ç”¨åŸç”Ÿè·ç¦»ï¼Œä¹Ÿä¸æŠŠæ‰€æœ‰å‘é‡ç”Ÿç¡¬æŠ•å½±åˆ°å•ä¸€ç©ºé—´ã€‚æˆ‘ä»¬åšçš„æ˜¯â€œæ¨¡æ€æ¡ä»¶ Mahalanobis è·ç¦» + å±€éƒ¨å¯¹é½æ ¡æ­£â€ï¼šæ‰“åˆ†åº¦é‡ä¸å†æ˜¯å…¨å±€å›ºå®šï¼Œè€Œæ˜¯æŒ‰â€œæŸ¥è¯¢æ¨¡æ€ Ã— æ‰€åœ¨å€™é€‰ç°‡çš„å±€éƒ¨ç»Ÿè®¡â€åŠ¨æ€è°ƒèŠ‚ã€‚
    - åœ¨DBä¸­åšembeddingå¤„ç†è¿‡ç¨‹
    - DB hybrid

æˆ‘ä»¬æŠŠå®ƒå«ä½œ å±€éƒ¨æ¨¡æ€äº’æ ¡å‡†è·ç¦» (Locally Calibrated Cross-Modal Distance, LC-CMD)ã€‚

### è®ºæ–‡å¤§çº²æ•´ç†å‡ºæ¥

### Design
#### è·¯ç”±å±‚è®¾è®¡
è§£å†³ç—›ç‚¹ Aï¼šOOD æŸ¥è¯¢èµ°ä¸åˆ°å¯¹çš„åŒºåŸŸï¼Œæˆ–è€…éœ€è¦å¤§é‡æ¡¥è¾¹å¯¼è‡´éå†çˆ†ç‚¸ã€‚

æˆ‘ä»¬æå‡ºä¸€ä¸ªä¸¤é˜¶æ®µè·¯ç”±ç­–ç•¥ï¼Œå«åš Multi-Entry Anchored Routing (MEAR)ï¼š

- è·¨æ¨¡æ€é”šç‚¹ (Anchors)
    - æˆ‘ä»¬ä»æ¯ä¸ªæ¨¡æ€çš„é«˜å¯†åº¦ç°‡ä¸­æŒ‘å‡ºè‹¥å¹²â€œç°‡ä¸­å¿ƒ + è·¨æ¨¡æ€å¯¹é½ç¨³å®šâ€çš„ä»£è¡¨ç‚¹ï¼Œç§°ä¸º anchorã€‚anchor çš„é€‰æ‹©å¯ä»¥é€šè¿‡æ£€ç´¢ K-means centerï¼Œä»è€Œé¿å…RoarGraphè¿™ç§ä¾èµ–å¤§é‡queryç¦»çº¿æŸ¥è¯¢çš„ã€‚ç±»ä¼¼ RoarGraph çš„â€œäºŒéƒ¨å›¾â€ç²¾ç¥ï¼Œä½†æˆ‘ä»¬åªä¿ç•™è¿™äº›é”šç‚¹ä¹‹é—´çš„è·¨æ¨¡æ€è¾¹ï¼Œè€Œä¸æ˜¯åœ¨ä»»æ„èŠ‚ç‚¹ä¸Šæ³›æ»¥åŠ è¾¹ã€‚è¿™æå¤§å‹ç¼©äº†é¢å¤–è¾¹æ•°ï¼Œè¾¹æ•°é‡å¢é•¿æ¥è¿‘ O(#anchors)ï¼Œè€Œä¸æ˜¯ O(#all_nodes)ã€‚
        - æ–°çš„è·ç¦»å‡½æ•° å¯¹é«˜å±‚ æ–°å¢è¾¹

- å¤šå…¥å£æœç´¢ (Multi-entry Seeds)
    - å½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ªæŸ¥è¯¢ qï¼ˆæ¯”å¦‚æ–‡æœ¬ï¼‰ï¼Œæˆ‘ä»¬ä¸ä¼šåªç”¨å•ä¸ªå…¥å£ç‚¹å¯åŠ¨å›¾æœç´¢ã€‚æˆ‘ä»¬é€šè¿‡è½»é‡çº§ç›¸ä¼¼åº¦æ£€ç´¢ï¼ˆä¾‹å¦‚ä½¿ç”¨å€’æ’ç°‡ä¸­å¿ƒè¡¨æˆ– IVF-like coarse quantizerï¼‰åœ¨ä¸åŒæ¨¡æ€çš„ anchor é›†åˆé‡Œå„æ‰¾å‡ºå‰ m ä¸ªç§å­ï¼Œç„¶åå¹¶è¡Œåœ¨å›¾é¡¶å±‚å‘èµ· m æ¡ BFS-like å°èŒƒå›´çˆ¬å±±ã€‚
    - å¥½å¤„æ˜¯ï¼š
        - OOD æŸ¥è¯¢å¾€å¾€â€œç¦»æ‰€æœ‰äººéƒ½è¿œâ€ï¼Œæ‰€ä»¥å•å…¥å£å®¹æ˜“å¡ä½ã€‚å¤šå…¥å£å¯ä»¥åœ¨ä¸åŒæ¨¡æ€è§†è§’åŒæ—¶è¯•æ¢ï¼Œä»è€Œæå‡åˆå§‹å¯è¾¾æ€§ã€‚RoarGraphæœ‰ç±»ä¼¼â€œå¼•å¯¼åˆ°é«˜å±‚è·¨ç°‡åŒºåŸŸâ€çš„ç›´è§‰ï¼Œä½†æˆ‘ä»¬æŠŠè¿™ä¸ªåšæˆæ˜¾å¼çš„å¤šå…¥å£è·¯ç”±ç­–ç•¥ã€‚
        - æœç´¢æ·±åº¦å¯ä»¥å—æ§ã€‚æˆ‘ä»¬ä¸éœ€è¦è®©æ¯ä¸ªå…¥å£éƒ½è·‘åˆ°å¾ˆæ·±ï¼Œè€Œæ˜¯æ”¶é›†å€™é€‰ç°‡ IDï¼Œç„¶åæŠŠè¿™äº›ç°‡äº¤ç»™é‡æ‰“åˆ†å±‚çš„ LC-CMD å»åšç²¾ç»†æ’åºã€‚
        - ä¸åŒçš„å…¥å£å¯ä»¥æœ‰ä¸ªæƒé‡ï¼Œé€æ­¥è¡°å‡(neighborsè·ç¦»qè¿œçš„å…¥å£è¢«æ›¿æ¢)ï¼›
    - é—®é¢˜(TODO)ï¼š
        - å¤šå…¥å£è¿™é‡Œï¼Œæ§åˆ¶ç›¸åŒrecallä¸‹ï¼ŒRoarGraph vs. æ–°æ–¹æ³• (early stopçš„é€»è¾‘)
        - æå‰validate recall

- ç°‡çº§å€™é€‰ï¼Œè€Œä¸æ˜¯èŠ‚ç‚¹çº§å€™é€‰
    - è·¯ç”±å±‚è¾“å‡ºçš„ä¸æ˜¯â€œè¿™ 500 ä¸ªå€™é€‰ç‚¹â€ï¼Œè€Œæ˜¯â€œè¿™ 5 ä¸ªå€™é€‰ç°‡ C1â€¦C5â€ã€‚æˆ‘ä»¬åªéœ€åœ¨æ¯ä¸ªç°‡é‡ŒæŠ“ä¸€å°æ’® top-L è¿‘é‚»ç‚¹è¿›å…¥é‡æ‰“åˆ†å±‚ï¼Œè€Œä¸éœ€è¦æ²¿å›¾æ·±è¿½æ‰€æœ‰å¯èƒ½é‚»æ¥ï¼Œä»è€Œå‰Šå‡é«˜å¬å›ä¸‹çš„ tail latencyã€‚


#### Rerank Layer
- æ¨¡æ€è‡ªå½’ä¸€åŒ– + è·¨æ¨¡æ€æ ¡æ­£ distance
- ä½œç”¨äºhigh layerï¼›ä¿®æ”¹é«˜å±‚è¿é€šæ€§ï¼›æ‰¾åˆ°æ›´ç²¾å‡†çš„å…¥å£

- ä¸ºä»€ä¹ˆä½¿ç”¨[Mahalanobis distance](https://en.wikipedia.org/wiki/Mahalanobis_distance)
    - è¿™æ˜¯ä¸€ç§è®¡ç®—ä¸¤ä¸ªæœªçŸ¥æ ·æœ¬é›†çš„ç›¸ä¼¼åº¦çš„ç®—æ³• (ç°æœ‰çš„çº¿æ€§æ–¹æ¡ˆå¯ä»¥è§†ä¸ºå­é›†)
    - Modality-Conditioned Extensionï¼š è€ƒè™‘ä¸åŒæ¨¡æ€çš„æ•°æ®çš„åˆ†å¸ƒä¸åŒï¼Œåƒä¼ ç»Ÿçº¿æ€§æ–¹æ³•ä¸€æ ·ï¼Œä¼šé€ æˆâ€œæ¨¡æ€ä¸»å¯¼â€é—®é¢˜ï¼›å› æ­¤ï¼Œå¼•å…¥æ¨¡æ€æ¡ä»¶çš„ Mahalanobis è·ç¦»ï¼š$$D_{MC}(x_i, y_j) = \sqrt{(x_i - y_j)^T \Sigma^{-1}_{c(i), c(j)} (x_i - y_j)}$$ å…¶ä¸­ï¼š(1). $c(i)$ è¡¨ç¤ºæ ·æœ¬ $i$ çš„æ¨¡æ€ï¼›(2). $\Sigma_{c(i), c(j)}$ æ˜¯ä¸æ¨¡æ€ç»„åˆ $(c(i), c(j))$ ç›¸å…³çš„åæ–¹å·®çŸ©é˜µï¼Œå¯å®šä¹‰ä¸ºï¼š
        - **å•æ¨¡æ€æ¡ä»¶ï¼ˆintra-modalï¼‰** æ—¶ï¼š$\Sigma_{c(i)}$
        - **è·¨æ¨¡æ€æ¡ä»¶ï¼ˆcross-modalï¼‰** æ—¶ï¼šå¯å– $\Sigma^{1/2}_{c(i)} \Sigma^{1/2}_{c(j)}$ æˆ–é€šè¿‡è”åˆå»ºæ¨¡è·å¾—çš„åæ–¹å·®çŸ©é˜µ
    - ä¸Šé¢çš„ç®—æ³•è™½ç„¶èƒ½å¤Ÿæ‹Ÿåˆä¸åŒåˆ†å¸ƒæ•°æ®çš„å…³ç³»ï¼Œæ¶ˆé™¤è·¨æ¨¡æ€distanceçš„é—®é¢˜ï¼›ä½†æ˜¯å…¶è®¡ç®—é‡å¤§ï¼ˆ$O(d^3)$å¤æ‚åº¦ï¼‰ï¼Œåæ–¹å·®çŸ©é˜µsizeå¤§ï¼ˆå­˜å‚¨æˆæœ¬$d^2$ * num_of_modalityï¼‰

- ç®—æ³•é™çº§(X-å›åˆ°äº†çº¿)ï¼šANNSè®¡ç®—çš„ä¸¤ä¸ªé«˜ç»´åº¦å‘é‡çš„distanceï¼ˆL2/Cosineï¼‰ï¼›å°†é«˜ç»´å‘é‡æ‹†åˆ†è€ƒè™‘çš„è¯ï¼šåœ¨æ¯ä¸€ä¸ªç»´åº¦ä¸Šï¼Œä¸åŒæ¨¡æ€çš„å‘é‡åˆ†å¸ƒç›¸åŒ/ä¸åŒå¯ä»¥ååº”åœ¨æ¯ä¸ªç»´åº¦çš„å‡å€¼å’Œæ–¹å·®ä¸Šã€‚ =ã€‹ ç­‰ä»·äºæŒ‰ç»´è¿›è¡Œå½’ä¸€åŒ–ï¼Œç„¶åè®¡ç®—distance
    - å¯¹æ¨¡æ€ $m$ï¼Œæˆ‘ä»¬ä¼°è®¡æ¯ä¸€ç»´çš„æ–¹å·®ï¼š$$\sigma_{m,k}^2 = \mathrm{Var}[x_k \mid \text{modality } m], \quad k = 1 \ldots d$$ ç„¶åå®šä¹‰ä¸€ä¸ªæŒ‰ç»´åº¦ç¼©æ”¾çš„ Mahalanobis-like è·ç¦»ï¼š$$D_m(q, x)^2 = \sum_{k=1}^{d} \frac{(q_k - x_k)^2}{\sigma_{m,k}^2 + \epsilon}$$ å·¥ç¨‹å±‚é¢å®ƒéå¸¸å¥½ï¼š
        - **å­˜å‚¨**ï¼šæ¯ä¸ªæ¨¡æ€åªå­˜ä¸€ä¸ªé•¿åº¦ä¸º $d$ çš„æ–¹å·®å‘é‡ $\sigma_m^2$ï¼Œæ˜¯ $O(d)$ã€‚
        - **è®¡ç®—**ï¼šè·ç¦»æ˜¯æŒ‰ç»´åº¦ç¼©æ”¾è¿‡çš„ L2ï¼Œæˆæœ¬ $O(d)$ï¼Œè·Ÿæ™®é€šä½™å¼¦/L2 åŒé˜¶ã€‚
        - **è®­ç»ƒ / ç»Ÿè®¡**ï¼š$\sigma_{m,k}^2$ å¯ä»¥ç”¨åœ¨çº¿ Welford-like ç®—æ³•åš streaming varianceï¼Œä¸ä¼šç‚¸å†…å­˜ã€‚
    - è·¨æ¨¡æ€æ£€ç´¢æ—¶ï¼Œæ¯”å¦‚æ–‡æœ¬æŸ¥è¯¢ $q$ æ£€ç´¢å›¾åƒå‘é‡ $x$ã€‚æ–‡æœ¬æ¨¡æ€ $t$ æ³¢åŠ¨å°ï¼Œå›¾åƒæ¨¡æ€ $v$ æ³¢åŠ¨å¤§ï¼Œç›´æ¥ L2 æ—¶ï¼Œå›¾åƒé‚£è¾¹å¤§å¹…åº¦çš„é«˜èƒ½ç»´ä¼šä¸»å¯¼è·ç¦»ã€‚æˆ‘ä»¬ç”¨ä¸‹é¢çš„èåˆç¼©æ”¾æ¥å¹³è¡¡å®ƒä»¬ï¼š$$D_{t \rightarrow v}(q, x)^2 = \sum_{k=1}^{d} \frac{(q_k - x_k)^2}{\alpha \sigma_{t,k}^2 + (1 - \alpha)\sigma_{v,k}^2 + \epsilon}$$ $\alpha$ å¯è®¾æˆ 0.5 å›ºå®šï¼Œæˆ–è§† query æ¨¡æ€åŠ¨æ€è°ƒèŠ‚ã€‚

- searchçš„æ—¶å€™
    - æ–°çš„è·ç¦»å‡½æ•° å¯¹é«˜å±‚ æ–°å¢è¾¹
        - ç›¸åŒæ¨¡æ€ é€€åŒ–L2 distance
        - ä¸åŒæ¨¡æ€ï¼Œå°†ä¸åŒæ¨¡æ€è€ƒè™‘è¿›å»


#### ä½¿ç”¨SSDè¯»å†™
- å¤šå…¥å£å¹¶è¡Œsearchå¢åŠ SSDè¯»å†™
- PQç æœ¬åœ¨å¤šæ¨¡æ€ä¸‹çš„å½±å“ -->